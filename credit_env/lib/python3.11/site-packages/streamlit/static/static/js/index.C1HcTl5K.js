import{r,E as j,_ as k,u as B,aJ as R,aK as G,m as x,aL as X,aM as $,aN as z,aO as L,aP as K,aQ as Q,o as F,aR as I,x as _,aS as Y,aT as Z,aU as q,J as ee,a6 as te,j as N,e as ne,aV as se,aW as ae,aX as re}from"./index.CD8HuT3N.js";import{w as oe,E as ie}from"./withFullScreenWrapper.DLp1ENGm.js";import{a as M,S as W,T as ce}from"./Toolbar.DSnK1fUh.js";import{R as le}from"./index.D3K5nOu9.js";import{u as ue}from"./FormClearHelper.DHh1GFzm.js";import"./sprintf.D7DtBTRn.js";import"./checkbox.D8W881TL.js";import"./createDownloadLinkElement.ZaXNnPK4.js";import"./toConsumableArray.D-Dx88BQ.js";import"./possibleConstructorReturn.DgiPnZ9N.js";import"./createSuper.B6W-Dh9S.js";import"./FileDownload.esm.DgBvV6Pq.js";var J=r.forwardRef(function(n,t){var a={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return r.createElement(j,k({iconAttrs:a,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),r.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),r.createElement("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"}))});J.displayName="InsertChart";var P=r.forwardRef(function(n,t){var a={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return r.createElement(j,k({iconAttrs:a,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),r.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),r.createElement("path",{d:"M20 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 2v3H5V5h15zm-5 14h-5v-9h5v9zM5 10h3v9H5v-9zm12 9v-9h3v9h-3z"}))});P.displayName="TableChart";const fe=20;function de(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&x(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const me=(n,t,a,s,o,f,u,h)=>{const e=JSON.parse(n);if(a==="streamlit"?e.config=R(e.config,o):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=R(e.config,o),e.usermeta.embedOptions.theme=void 0):e.config=G(e.config,o),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(u-40,0)),f?(e.width=u,e.height=h,"vconcat"in e&&e.vconcat.forEach(l=>{l.width=u})):t&&(e.width=u,"vconcat"in e&&e.vconcat.forEach(l=>{l.width=u})),e.padding||(e.padding={}),x(e.padding.bottom)&&(e.padding.bottom=fe),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return s.length>0&&de(e),e},he=(n,t,a,s)=>{const o=B(),{id:f,formId:u,spec:h,data:e,datasets:l,useContainerWidth:i,vegaLiteTheme:p,selectionMode:c}=n,S=r.useMemo(()=>c,[JSON.stringify(c)]),y=r.useMemo(()=>me(h,i,p,S,o,t,a||0,s),[h,i,p,S,o,t,a,s]);return{id:f,formId:u,vegaLiteTheme:p,spec:y,selectionMode:S,data:e,datasets:l,useContainerWidth:i}},pe={DATAFRAME_INDEX:"(index)"};function ge(n){return!n||n.dimensions.numDataRows===0?null:A(n)}function Se(n){const t=D(n);if(x(t))return null;const a={};for(const[s,o]of Object.entries(t))a[s]=A(o);return a}function D(n){if(n?.length===0)return null;const t={};return n.forEach(a=>{if(!a)return;const s=a.hasName?a.name:null;t[s]=a.data}),t}function A(n,t=0){if(n.dimensions.numDataRows===0)return[];const a=[],{numDataRows:s,numDataColumns:o,numIndexColumns:f}=n.dimensions,u=n.columnTypes[0]??void 0,h=u&&u.type===X.INDEX&&($(u)||z(u)||L(u));for(let e=t;e<s;e++){const l={};if(h){const{content:i}=n.getCell(e,0);l[pe.DATAFRAME_INDEX]=typeof i=="bigint"?Number(i):i}for(let i=0;i<o;i++){const p=i+f,{content:c,contentType:S}=n.getCell(e,p);if((c instanceof Date||typeof c=="number"&&Number.isFinite(c))&&(z(S)||L(S))&&!K(S)){const y=new Date(c).getTimezoneOffset()*60*1e3;l[n.columnNames[0][p]]=c.valueOf()+y}else l[n.columnNames[0][p]]=typeof c=="bigint"?Number(c):c}a.push(l)}return a}const ye=150,we=_.getLogger("useVegaLiteSelections"),Ce=(n,t,a)=>{const{id:s,formId:o,selectionMode:f}=n,u=r.useCallback(e=>{f.forEach(i=>{e.addSignalListener(i,Q(ye,(p,c)=>{const S=e.getState({data:(w,C)=>f.some(V=>`${V}_store`===w),recurse:!1});F(S)&&t.setElementState(s,"viewState",S);let y=c;"vlPoint"in c&&"or"in c.vlPoint&&(y=c.vlPoint.or);const E={id:s,formId:o},g=JSON.parse(t.getStringValue(E)||"{}"),d={selection:{...g?.selection||{},[p]:y||{}}};I(g,d)||t.setStringValue(E,JSON.stringify(d),{fromUi:!0},a)}))});const l=t.getElementState(s,"viewState");if(F(l))try{return e.setState(l)}catch(i){we.warn("Failed to restore view state",i)}return e},[s,f,t,o,a]),h=r.useCallback(()=>{const e={selection:{}};f.forEach(c=>{e.selection[c]={}});const l={id:s,formId:o},i=t.getStringValue(l),p=i?JSON.parse(i):e;I(p,e)||t.setStringValue(l,JSON.stringify(e),{fromUi:!0},a)},[s,o,a,f,t]);return{maybeConfigureSelections:u,onFormCleared:h}},H="source",be=_.getLogger("useVegaEmbed");function Ee(n,t,a){const s=r.useRef(null),o=r.useRef(null),f=r.useRef(H),u=r.useRef(null),h=r.useRef([]),{maybeConfigureSelections:e,onFormCleared:l}=Ce(n,t,a);ue({widgetMgr:t,element:n,onFormCleared:l});const{data:i,datasets:p}=n;r.useEffect(()=>{s.current===null&&(u.current=i,h.current=p)},[i,p]);const c=r.useCallback(()=>{o.current&&o.current(),o.current=null,s.current=null},[]),S=r.useCallback(async(g,d)=>{if(g.current===null)throw new Error("Element missing.");c();const w={ast:!0,expr:Z,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:C,view:V,finalize:b}=await Y(g.current,d,w);s.current=e(V),o.current=b;const m=Se(h.current),v=m?Object.keys(m):[];if(v.length===1){const[O]=v;f.current=O}else v.length===0&&C.data&&(f.current=H);const T=ge(u.current);if(T&&s.current.insert(f.current,T),m)for(const[O,U]of Object.entries(m))s.current.insert(O,U);return await s.current.runAsync(),await s.current.resize().runAsync(),s.current},[c,e]),y=r.useCallback((g,d,w,C)=>{if(!C||C.dimensions.numDataRows===0){try{g.remove(d,q)}finally{}return}if(!w||w.dimensions.numDataRows===0){g.insert(d,A(C));return}C.hash!==w.hash&&(g.data(d,A(C)),be.info(`Had to clear the ${d} dataset before inserting data through Vega view.`))},[]),E=r.useCallback(async(g,d)=>{if(s.current===null)return null;const w=u.current,C=h.current;(w||g)&&y(s.current,f.current,w,g);const V=D(C)??{},b=D(d)??{};for(const[m,v]of Object.entries(b)){const T=m||f.current,O=V[T];y(s.current,T,O,v)}for(const m of Object.keys(V))!Object.hasOwn(b,m)&&m!==f.current&&y(s.current,m,null,null);return await s.current?.resize().runAsync(),u.current=g,h.current=d,s.current},[y]);return{createView:S,updateView:E,finalizeView:c}}function Ve(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const ve=({disableFullscreenMode:n,element:t,fragmentId:a,widgetMgr:s})=>{const[o,f]=r.useState(!1),[u,h]=r.useState(!1),{expanded:e,height:l,width:i,expand:p,collapse:c}=ee(ie),{width:S,height:y,elementRef:E}=te([o],0),g=Ve(t.spec),d=he(t,e,g?i??0:S,l??0),{createView:w,updateView:C,finalizeView:V}=Ee(d,s,a),{data:b,datasets:m,spec:v}=d;return r.useLayoutEffect(()=>(E.current!==null&&w(E,v),V),[w,V,v,i,l,o,E]),r.useEffect(()=>{C(b,m)},[b,m,C]),r.useEffect(()=>{b||m&&m[0]?.data?h(!0):h(!1)},[b,m]),o?N(le,{data:b??m[0]?.data,height:l??y??void 0,customToolbarActions:[N(M,{label:"Show chart",icon:J,onClick:()=>{f(!1)}},"show-chart")]}):ne(W,{height:l,useContainerWidth:d.useContainerWidth,children:[N(ce,{target:W,isFullScreen:e,onExpand:p,onCollapse:c,disableFullscreenMode:n,children:u&&N(M,{label:"Show data",icon:P,onClick:()=>{f(!0)}})}),N(ae,{styles:[se]}),N(re,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:d.useContainerWidth,isFullScreen:e,ref:E})]})},Ne=oe(ve),He=r.memo(Ne);export{se as StyledVegaLiteChartTooltips,R as applyStreamlitTheme,He as default};
